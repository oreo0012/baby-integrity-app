# 人物庆祝/打击动画播放两次问题修复

## 问题描述
测试时发现人物庆祝/打击动画会播放两次，而不是只播放1次。

## 问题分析

### 可能原因1：帧数不匹配
- **配置中的帧数**：95帧
- **实际素材帧数**：94帧（95个文件 - 1个目录）
- **影响**：可能导致 FFmpeg 读取错误或重复帧

### 可能原因2：GIF 循环设置
- 虽然配置中设置了 `loop: false`，但需要确认 GIF 文件是否真的设置为只播放1次

### 可能原因3：时长计算
- 94帧 ÷ 24fps = 3.917秒
- 代码中设置为 4秒
- 0.083秒的差异可能导致时序问题

## 解决方案

### 1. 修正帧数配置
在 `scripts/convert-animations.js` 中，将庆祝和打击动画的帧数从95改为94：

```javascript
// 人物加扣分动画（播放1次）
{ 
  name: '送花_庆祝', 
  input: 'D:\\...\\送花_庆祝\\送花_庆祝_%05d.png',
  output: 'girl-celebrate.gif',
  frames: 94,  // 修正：95 → 94
  loop: false
},
{ 
  name: '扣花_打击', 
  input: 'D:\\...\\扣花_打击\\扣花_打击_%05d.png',
  output: 'girl-sad.gif',
  frames: 94,  // 修正：95 → 94
  loop: false
}
```

### 2. 更新注释
在 `GirlAnimation.tsx` 中更新注释：

```typescript
// 临时动画时长：94帧 ÷ 24fps ≈ 3.917秒，向上取整为4秒
const timer = setTimeout(() => {
  // ...
}, 4000);
```

### 3. 重新生成动画
```bash
cd baby-integrity-app
node scripts/convert-animations.js
```

## 验证结果

重新生成后的文件：
- `girl-celebrate.gif`: 2.88 MB, 94帧, 只播放1次
- `girl-sad.gif`: 2.57 MB, 94帧, 只播放1次

## 测试步骤

1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 刷新页面（Ctrl+F5）
3. 点击"送花"，选择一个项目
4. 观察人物庆祝动画：
   - ✅ 应该只播放1次
   - ✅ 播放时长约4秒
   - ✅ 播放结束后切换到常态动画
5. 点击"扣花"，选择一个项目
6. 观察人物打击动画：
   - ✅ 应该只播放1次
   - ✅ 播放时长约4秒
   - ✅ 播放结束后切换到常态动画

## 动画时长对照表

| 动画类型 | 实际帧数 | 帧率 | 实际时长 | 代码设置 | 差异 |
|---------|---------|------|---------|---------|------|
| 送花动画 | 33帧 | 24fps | 1.375秒 | 1.4秒 | +0.025秒 |
| 扣花动画 | 33帧 | 24fps | 1.375秒 | 1.4秒 | +0.025秒 |
| 人物庆祝 | 94帧 | 24fps | 3.917秒 | 4秒 | +0.083秒 |
| 人物打击 | 94帧 | 24fps | 3.917秒 | 4秒 | +0.083秒 |
| 优秀常态 | 168帧 | 24fps | 7秒 | 循环 | - |
| 良好常态 | 168帧 | 24fps | 7秒 | 循环 | - |
| 要加油常态 | 168帧 | 24fps | 7秒 | 循环 | - |

## 注意事项

1. **清除缓存**：修改 GIF 文件后，必须清除浏览器缓存才能看到新文件
2. **GIF 缓存修复**：已在 `GirlAnimation.tsx` 中添加唯一查询参数，确保每次加载新 GIF
3. **时长设置**：代码中的时长略大于实际时长是正常的，留有缓冲时间

## 相关文件
- `scripts/convert-animations.js` - 动画转换脚本（修正帧数）
- `src/components/GirlAnimation.tsx` - 人物动画组件（更新注释）
- `public/animations/girl-celebrate.gif` - 庆祝动画（重新生成）
- `public/animations/girl-sad.gif` - 打击动画（重新生成）

## 如果问题仍然存在

如果清除缓存后问题仍然存在，可能的原因：

1. **GIF 本身循环**：使用工具检查 GIF 的循环设置
   ```bash
   ffprobe public/animations/girl-celebrate.gif
   ```

2. **React 组件重复渲染**：检查控制台日志，看是否有重复的"播放临时动画"日志

3. **定时器未清理**：检查是否有多个定时器同时运行

## 修复记录

### 2025-01-21
- 修正庆祝和打击动画的帧数配置：95 → 94
- 更新 `GirlAnimation.tsx` 中的注释
- 重新生成 `girl-celebrate.gif` 和 `girl-sad.gif`
