# 动画系统测试指南

## 测试目标

验证以下功能是否正常工作：
1. ✅ 随机分值滚动效果
2. ✅ 动画播放次数正确（不重复）
3. ✅ 人物动画结束后恢复常态动画
4. ✅ 分数更新后切换到正确的常态动画
5. ✅ 进度条颜色根据分段变化

## 测试场景

### 场景 1: 优秀状态 → 良好状态

**初始状态**: 分数 95 分（优秀）

**操作步骤**:
1. 点击"扣花"
2. 选择一个扣分项（例如"不听话" -10分）
3. 观察动画流程

**预期结果**:
- ✅ 模态框立即关闭
- ✅ 显示随机数字滚动（1秒）
- ✅ 播放扣花动画（1.4秒）
- ✅ 播放人物打击动画（4秒）- 替换优秀常态动画
- ✅ 恢复到**良好常态动画**（因为 95-10=85，属于良好分段）
- ✅ 进度条颜色变为**黄色**
- ✅ 显示通知

**关键检查点**:
- 人物打击动画结束后，应该显示**良好常态动画**，而不是优秀常态动画
- 进度条颜色应该从绿色变为黄色

### 场景 2: 良好状态 → 要加油状态

**初始状态**: 分数 65 分（良好）

**操作步骤**:
1. 点击"扣花"
2. 选择一个扣分项（例如"不听话" -10分）
3. 观察动画流程

**预期结果**:
- ✅ 播放扣花动画
- ✅ 播放人物打击动画
- ✅ 恢复到**要加油常态动画**（因为 65-10=55，属于要加油分段）
- ✅ 进度条颜色变为**红色**

### 场景 3: 要加油状态 → 良好状态

**初始状态**: 分数 55 分（要加油）

**操作步骤**:
1. 点击"送花"
2. 选择一个加分项（例如"主动学习" +10分）
3. 观察动画流程

**预期结果**:
- ✅ 播放送花动画
- ✅ 播放人物庆祝动画
- ✅ 恢复到**良好常态动画**（因为 55+10=65，属于良好分段）
- ✅ 进度条颜色变为**黄色**

### 场景 4: 良好状态 → 优秀状态

**初始状态**: 分数 85 分（良好）

**操作步骤**:
1. 点击"送花"
2. 选择一个加分项（例如"主动学习" +10分）
3. 观察动画流程

**预期结果**:
- ✅ 播放送花动画
- ✅ 播放人物庆祝动画
- ✅ 恢复到**优秀常态动画**（因为 85+10=95，属于优秀分段）
- ✅ 进度条颜色变为**绿色**

### 场景 5: 同分段内加减分

**初始状态**: 分数 95 分（优秀）

**操作步骤**:
1. 点击"扣花"
2. 选择一个小扣分项（例如 -3分）
3. 观察动画流程

**预期结果**:
- ✅ 播放扣花动画
- ✅ 播放人物打击动画
- ✅ 恢复到**优秀常态动画**（因为 95-3=92，仍属于优秀分段）
- ✅ 进度条颜色保持**绿色**

## 分段规则

| 分数范围 | 分段名称 | 常态动画 | 进度条颜色 |
|---------|---------|---------|-----------|
| 90-100 | 优秀 | girl-excellent.gif | 绿色 (green-400 to green-500) |
| 60-89 | 良好 | girl-good.gif | 黄色 (yellow-400 to yellow-500) |
| 0-59 | 要加油 | girl-needwork.gif | 红色 (red-400 to red-500) |

## 动画时长参考

| 动画 | 时长 | 说明 |
|------|------|------|
| 随机数字滚动 | 1秒 | 数字快速变化 |
| 送花/扣花动画 | 1.4秒 | 34帧 ÷ 24fps |
| 停留 | 1秒 | 动画结束后停留 |
| 渐隐 | 0.5秒 | 淡出效果 |
| 人物庆祝/打击 | 4秒 | 95帧 ÷ 24fps |
| **总时长** | **约 7.9秒** | 完整流程 |

## 常见问题排查

### 问题 1: 动画播放两次
**原因**: useEffect 依赖项包含回调函数
**解决**: 已使用 useRef 存储回调，避免重复触发

### 问题 2: 人物动画卡在最后一帧
**原因**: GIF 不会自动重新播放
**解决**: 使用 imageKey 强制重新渲染

### 问题 3: 分数更新后常态动画没有切换
**原因**: 临时动画播放期间，分数更新被忽略
**解决**: 使用 scoreRef 存储最新分数，临时动画结束时使用最新分数

### 问题 4: 进度条颜色不对
**原因**: 分段判断逻辑错误
**解决**: 已修正为 90+、60-89、0-59 三个分段

## 浏览器控制台日志

正常流程应该看到以下日志：

```
App: 开始播放 flower-add 动画
开始播放动画: flower-add, 目标分值: 8
随机滚动结束，最终分值: 8
flower-add 动画播放完成，开始渐隐
flower-add 动画完全结束
App: flower-add 动画完成
App: 开始播放庆祝动画
播放临时动画: celebrate
临时动画结束，使用最新分数: 103
选择优秀动画 (分数: 103)
App: 人物动画结束
```

## 测试清单

- [ ] 随机数字滚动流畅
- [ ] 送花动画播放 1 次
- [ ] 扣花动画播放 1 次
- [ ] 人物庆祝动画播放 1 次
- [ ] 人物打击动画播放 1 次
- [ ] 动画结束后恢复常态动画
- [ ] 跨分段时切换到正确的常态动画
- [ ] 进度条颜色正确（绿/黄/红）
- [ ] 进度条宽度动画流畅
- [ ] 通知显示正确

## 性能检查

- [ ] 动画加载时间 < 2秒
- [ ] 动画播放流畅，无卡顿
- [ ] 内存占用正常
- [ ] 多次操作后无内存泄漏
